name: Nirmata nctl Scan (PodSecurity Baseline & Restricted)

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
#  schedule:
#    - cron: '0 0 * * *' # daily scan at midnight UTC

jobs:
  scan:
    name: Scan with nctl
    runs-on: ubuntu-latest

    env:
#      NIRMATA_TEAM_TOKEN: ${{ secrets.NIRMATA_TEAM_TOKEN }}
#      NIRMATA_USER_TOKEN: ${{ secrets.NIRMATA_USER_TOKEN }}
#      NIRMATA_USER_ID: ${{ secrets.NIRMATA_USERID }}
      NIRMATA_URL: ${{ secrets.NIRMATA_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install nctl
        uses: nirmata/action-install-nctl-scan@v0.0.11

      - name: Verify nctl version
        run: nctl version

      - name: Debug check env (safe)
        run: |
          echo "NIRMATA_URL is: $NIRMATA_URL"
          echo "NIRMATA_TOKEN length: ${#NIRMATA_TOKEN}"

#      - name: Login to Nirmata as a DevOps User
#        run: |
#          nctl login nch --url $NIRMATA_URL --token $NIRMATA_USER_TOKEN

#      - name: Login to Nirmata as a DevOps User
#        env:
#          NIRMATA_TOKEN: ${{ secrets.NIRMATA_USER_TOKEN }}
#        run: |
#          echo "Running with user token..."
#          nctl whoami

      - name: Run nctl scan (PodSecurity)
        env:
          NIRMATA_TOKEN: ${{ secrets.NIRMATA_TEAM_TOKEN }}
        run: |
          nctl scan repository --policy-sets pss-baseline,pss-restricted --url $NIRMATA_URL --token $NIRMATA_TEAM_TOKEN

      - name: Provide next steps
        run: |
          echo "âœ… NCTL scan completed."
          echo ""
          echo "ðŸ‘‰ Review policy violations here:"
          echo "   https://www.nirmata.io/webclient/#clusters/policyReport/repositoryDetails?repo=https%3A%2F%2Fgithub.com%2Fnirmata%2Fsample-polex&backurl=clustersPolicyReport%2Frepositories&filter.status.value=fail"
          echo ""
          echo "ðŸ‘‰ Create policy exceptions here:"
          echo "   https://www.nirmata.io/webclient/#clusters/policyReport/repositoryDetails?repo=https%3A%2F%2Fgithub.com%2Fnirmata%2Fsample-polex&backurl=clustersPolicyReport%2Frepositories&filter.status.value=fail"
          echo ""
          echo "ðŸ“Š Results are also available in the Nirmata Control Hub."