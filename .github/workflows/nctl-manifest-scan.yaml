name: Nirmata nctl Scan (PodSecurity Baseline & Restricted)

on:
  push:
    branches: [ main ]
  # pull_request:
  #   branches: [ main ]
  # schedule:
  #   - cron: '0 0 * * *' # daily scan at midnight UTC

jobs:
  scan:
    name: Scan with nctl
    runs-on: ubuntu-latest

    env:
      # NIRMATA_TEAM_TOKEN: ${{ secrets.NIRMATA_TEAM_TOKEN }}
      # NIRMATA_USER_TOKEN: ${{ secrets.NIRMATA_USER_TOKEN }}
      # NIRMATA_USER_ID: ${{ secrets.NIRMATA_USERID }}
      NIRMATA_URL: ${{ secrets.NIRMATA_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install nctl
        uses: nirmata/action-install-nctl-scan@v0.0.2

      - name: Verify nctl version
        run: nctl version

      - name: Login to Nirmata as a DevOps User
        env:
          NIRMATA_TOKEN: ${{ secrets.NIRMATA_USER_TOKEN }}
        run: |
          echo "Running with user token..."
          nctl version

      - name: Run nctl scan (PodSecurity)
        env:
          NIRMATA_TOKEN: ${{ secrets.NIRMATA_TEAM_TOKEN }}
        run: |
          set +e
          echo "=== Starting nctl scan ==="
          nctl scan repository --policy-sets pss-baseline,pss-restricted --url $NIRMATA_URL --token ${{ secrets.NIRMATA_TEAM_TOKEN }} --publish
          status=$?
          set -e

          echo "=== nctl scan completed with status: $status ==="

          if [ $status -ne 0 ] && [ $status -ne 1 ]; then
            echo "nctl scan failed with (status $status)"
            exit $status
          fi

          echo "nctl completed (status $status). Violations may exist but workflow continues."
          # 0 = success, no violations → workflow passes
          # 1 = violations found → workflow passes (but you can still parse results)
          # >1 = CLI error → workflow fails

      - name: Post NCTL Run Summary
        run: |
          echo "### Nirmata Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "[Review Policy Violations](https://nirmata.io/webclient/#clusters/policyReport/repositoryDetails?repo=https%3A%2F%2Fgithub.com%2Fnirmata%2Fsample-polex&backurl=clustersPolicyReport%2Frepositories&filter.status.value=fail)" >> $GITHUB_STEP_SUMMARY
          echo "[Request Policy Exceptions](https://nirmata.io/webclient/#clusters/policyReport/repositoryDetails?repo=https%3A%2F%2Fgithub.com%2Fnirmata%2Fsample-polex&backurl=clustersPolicyReport%2Frepositories&filter.status.value=fail)" >> $GITHUB_STEP_SUMMARY
